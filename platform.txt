# STC8G Platform Configuration
name=STC8G Boards
version=1.0.0

# Compiler paths
compiler.path={runtime.tools.sdcc.path}/bin/
compiler.wrapper.path={runtime.platform.path}/tools/wrapper

# Warning flags
compiler.warning_flags=--less-pedantic

# Compiler commands
compiler.c.cmd=sdcc
compiler.c.wrapper=sdcc.sh
compiler.c.flags=-MMD -c -Ddouble=float -DUSE_STDINT -D__PROG_TYPES_COMPAT__ {compiler.warning_flags}

compiler.cpp.cmd=sdcc
compiler.cpp.wrapper=sdcc.sh
compiler.cpp.flags={compiler.c.flags}

compiler.ar.cmd=sdar
compiler.ar.wrapper=sdar.sh
compiler.ar.flags=rcs

compiler.c.elf.cmd=sdcc
compiler.c.elf.wrapper=sdcc-link.sh
compiler.c.elf.flags=--nostdlib --code-size {upload.maximum_size} --xram-size {upload.maximum_data_size} --xram-loc {upload.xdata_location}

compiler.elf2hex.cmd=packihx
compiler.elf2hex.wrapper=packihx.sh
compiler.size.cmd=cat

# System includes (adjust if SDCC is in different location)
compiler.systemincludes="-I{runtime.tools.sdcc.path}/share/sdcc/include"

# Build extra flags
build.extra_flags=

# Compile patterns using wrappers
## Compile c files
recipe.c.o.pattern="{compiler.wrapper.path}/{compiler.c.wrapper}" "{compiler.path}{compiler.c.cmd}" "{source_file}" "{object_file}" c {compiler.c.flags} -mmcs51 -D{build.mcu} -DF_CPU={build.f_cpu} -DARDUINO={runtime.ide.version} -DARDUINO_{build.board} -DARDUINO_ARCH_{build.arch} {build.extra_flags} {includes} {compiler.systemincludes}

## Compile cpp files (wrapper handles .cpp -> .c conversion)
recipe.cpp.o.pattern="{compiler.wrapper.path}/{compiler.cpp.wrapper}" "{compiler.path}{compiler.cpp.cmd}" "{source_file}" "{object_file}" cpp {compiler.cpp.flags} -mmcs51 -D{build.mcu} -DF_CPU={build.f_cpu} -DARDUINO={runtime.ide.version} -DARDUINO_{build.board} -DARDUINO_ARCH_{build.arch} {build.extra_flags} {includes} {compiler.systemincludes}

## Create archives
recipe.ar.pattern="{compiler.wrapper.path}/{compiler.ar.wrapper}" "{compiler.path}{compiler.ar.cmd}" "{archive_file_path}" "{object_file}" ar {compiler.ar.flags}

## Combine/Link
recipe.c.combine.pattern="{compiler.wrapper.path}/{compiler.c.elf.wrapper}" "{compiler.path}{compiler.c.elf.cmd}" {compiler.c.elf.flags} "-L{build.path}" "-L{runtime.tools.sdcc.path}/share/sdcc/lib/small" -mmcs51 -D{build.mcu} {object_files} "{build.path}/{archive_file}" -lmcs51 -llibsdcc -lliblong -lliblonglong -llibint -llibfloat --out-fmt-ihx -o "{build.path}/{build.project_name}.ihx"

## Create hex
recipe.objcopy.hex.pattern="{compiler.wrapper.path}/{compiler.elf2hex.wrapper}" "{compiler.path}{compiler.elf2hex.cmd}" "{build.path}/{build.project_name}.ihx" "{build.path}/{build.project_name}.hex"

## Compute size
recipe.size.pattern="{compiler.size.cmd}" "{build.path}/{build.project_name}.mem"
recipe.size.regex=^(?:\s+ROM\/EPROM\/FLASH)\s+0x[A-Fa-f0-9]+\s+0x[A-Fa-f0-9]+\s+([0-9]+).*
recipe.size.regex.data=^(?:\s+EXTERNAL RAM)\s+0x[A-Fa-f0-9]+\s+0x[A-Fa-f0-9]+\s+([0-9]+).*

## Preprocessor
preproc.macros.flags=-E -dM
recipe.preproc.macros="{compiler.wrapper.path}/{compiler.cpp.wrapper}" "{compiler.path}{compiler.cpp.cmd}" "{source_file}" "{preprocessed_file_path}" preproc {compiler.cpp.flags} {preproc.macros.flags} -mmcs51 -D{build.mcu} -DF_CPU={build.f_cpu} -DARDUINO={runtime.ide.version} -DARDUINO_{build.board} -DARDUINO_ARCH_{build.arch} {build.extra_flags} {includes} {compiler.systemincludes}

# Upload using stcgal with frequency setting
tools.stcgal.cmd=stcgal
tools.stcgal.path={runtime.tools.stcgal.path}
tools.stcgal.upload.params.verbose=-v
tools.stcgal.upload.params.quiet=
# Pass -t option to set target frequency in kHz (convert F_CPU from Hz to kHz)
tools.stcgal.upload.pattern="{cmd}" -p {serial.port} -t {build.f_cpu_khz} "{build.path}/{build.project_name}.ihx"

# USB Default Flags
build.usb_flags=-DUSB_VID={build.vid} -DUSB_PID={build.pid} '-DUSB_MANUFACTURER={build.usb_manufacturer}' '-DUSB_PRODUCT={build.usb_product}'